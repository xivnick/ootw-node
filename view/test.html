<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚ ì”¨ ë° ì½”ë”” ì¶”ì²œ</title>
    <!-- Chart.js & DataLabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
    <style>
        :root {
            --primary-color: #007bff;
            --bg-color: #f9faff;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-radius: 12px;
            --spacing: 16px;
        }
        * { box-sizing: border-box; }
        body, html {
            margin:0; padding:0;
            width:100%; height:100%;
            font-family:Arial, sans-serif;
            background:var(--bg-color);
            color:var(--text-color);
            display:flex; justify-content:center; align-items:center;
        }
        #container {
            width:100%; max-width:520px;
            background:var(--card-bg);
            border-radius:var(--border-radius);
            box-shadow:0 4px 16px rgba(0,0,0,0.08);
            padding:var(--spacing);
            display:flex; flex-direction:column; gap:var(--spacing);
        }
        h2 { margin:0; font-size:1.5rem; text-align:center; }
        .controls { display:flex; gap:var(--spacing); justify-content:center; }
        button, input, select {
            font-size:1rem; padding:0.6rem 1rem;
            border-radius:var(--border-radius); border:1px solid #ccc;
        }
        button {
            background:var(--primary-color); color:#fff; border:none;
            cursor:pointer; transition:background 0.2s;
        }
        button:hover:not(:disabled) { background:#0063cc; }
        button:disabled { background:#bbb; cursor:default; }
        input { flex:1; border-color:#ddd; }
        #search-results {
            list-style:none; margin:0; padding:0;
            max-height:10rem; overflow-y:auto;
            border:1px solid #eee; border-radius:var(--border-radius);
        }
        #search-results li {
            padding:0.75rem 1rem; cursor:pointer;
            transition:background 0.2s;
        }
        #search-results li:hover { background:#f1f1f1; }
        #location-name {
            font-weight:bold; text-align:center;
            font-size:1.2rem;
        }
        #summary {
            background:var(--bg-color);
            border-radius:var(--border-radius);
            padding:var(--spacing);
            display:flex; flex-direction:column;
            align-items:center; gap:0.5rem;
        }
        .emoji-large { font-size:3rem; }
        .summary-text { font-size:1rem; }
        #style-options {
            display:flex; justify-content:center; gap:var(--spacing);
        }
        #style-options label {
            display:flex; align-items:center; gap:0.25rem;
            cursor:pointer;
        }
        #outfit {
            background:var(--bg-color);
            border-radius:var(--border-radius);
            padding:var(--spacing);
            text-align:center;
            font-size:1rem;
        }
        #chart-container {
            background:var(--card-bg);
            border-radius:var(--border-radius);
            padding:var(--spacing);
        }
        canvas { width:100% !important; height:14rem !important; display:block; }
    </style>
</head>
<body>
    <div id="container">
        <h2>ë‚ ì”¨ ë° ì½”ë”” ì¶”ì²œ</h2>
        <div class="controls">
            <button id="btn-loc">ğŸ“ í˜„ì¬ ìœ„ì¹˜</button>
            <input id="search-input" placeholder="ì§€ì—­ ê²€ìƒ‰">
            <button id="btn-search">ğŸ” ê²€ìƒ‰</button>
        </div>
        <ul id="search-results"></ul>
        <div id="location-name"></div>
        <div id="summary"></div>
        <div id="style-options">
            <label><input type="radio" name="style" value="normal" checked> ë¬´ë‚œ</label>
            <label><input type="radio" name="style" value="formal"> í¬ë©€</label>
            <label><input type="radio" name="style" value="casual"> ìºì£¼ì–¼</label>
            <label><input type="radio" name="style" value="fancy"> ê¾¸ë¯¼</label>
        </div>
        <div id="outfit">ì½”ë””ë¥¼ ì¶”ì²œë°›ìœ¼ë ¤ë©´ ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
        <div id="chart-container">
            <canvas id="weather-chart"></canvas>
        </div>
    </div>
    <script>
        Chart.register(ChartDataLabels);
        const btnLoc = document.getElementById('btn-loc');
        const btnSearch = document.getElementById('btn-search');
        const searchInput = document.getElementById('search-input');
        const resultsEl = document.getElementById('search-results');
        const nameEl = document.getElementById('location-name');
        const summaryEl = document.getElementById('summary');
        const outfitEl = document.getElementById('outfit');
        const styleInputs = document.querySelectorAll('input[name="style"]');
        let chart, lastForecast;

        // ë‚ ì”¨ ì¡°íšŒ
        async function fetchWeather(nx, ny) {
            const d = new Date();
            const date = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
            const res = await fetch(`/weather?nx=${nx}&ny=${ny}&date=${date}`);
            return res.json();
        }

        // ìš”ì•½ ìƒì„±
        function generateSummary(forecast) {
            const temps = forecast.map(f => Number(f.TMP));
            const max = Math.max(...temps), min = Math.min(...temps);
            const pops = forecast.map(f => parseInt(f.POP) || 0);
            const popMax = Math.max(...pops);
            let emoji='ğŸŒ¥ï¸', text='ì˜¤ëŠ˜ì€ íë¦½ë‹ˆë‹¤';
            if (popMax > 30) { emoji='ğŸŒ§ï¸'; text='ì˜¤ëŠ˜ì€ ë¹„ê°€ ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤'; }
            else {
                const sky = forecast.reduce((c,v)=>{c[v.SKY]=(c[v.SKY]||0)+1;return c;},{});
                if ((sky['1']||0) >= (sky['3']||0) && (sky['1']||0) >= (sky['4']||0)) {
                    emoji='â˜€ï¸'; text='ì˜¤ëŠ˜ì€ ë§‘ìŠµë‹ˆë‹¤';
                } else if ((sky['3']||0) >= (sky['4']||0)) {
                    emoji='â˜ï¸'; text='ì˜¤ëŠ˜ì€ êµ¬ë¦„ì´ ë§ìŠµë‹ˆë‹¤';
                }
            }
            const summary = `${text}. ìµœê³  ${max}Â°, ìµœì € ${min}Â°` +
                (popMax>0 ? `, ê°•ìˆ˜ í™•ë¥  ìµœê³  ${popMax}%ì…ë‹ˆë‹¤.` : 'ì…ë‹ˆë‹¤.');
            return {emoji, summary};
        }

        // 06ì‹œ~23ì‹œ í‰ê·  ê¸°ì˜¨ ê³„ì‚°
        function calcAvgTemp(forecast) {
            const filtered = forecast.filter(f => {
                const h = parseInt(f.time.slice(0,2));
                return h >= 6 && h <= 23;
            });
            const temps = filtered.map(f => Number(f.TMP));
            const sum = temps.reduce((a,b)=>a+b,0);
            return sum / temps.length;
        }

        // ìš”ì•½ ë Œë” ë° í‰ê·  ê¸°ì˜¨ ì €ì¥
        function renderSummary(forecast, name) {
            lastForecast = forecast;
            const { emoji, summary } = generateSummary(forecast);
            nameEl.textContent = name;
            summaryEl.innerHTML = `
                <div class="emoji-large">${emoji}</div>
                <div class="summary-text">${summary}</div>
            `;
            updateOutfit();
        }

        // ì°¨íŠ¸ ë Œë”
        function renderChart(forecast) {
            const labels = forecast.map(f => `${f.time.slice(0,2)}ì‹œ`);
            const temps = forecast.map(f => Number(f.TMP));
            const maxI = temps.indexOf(Math.max(...temps));
            const minI = temps.indexOf(Math.min(...temps));
            const buf = 2, maxT = temps[maxI], minT = temps[minI];
            const suggestedMax = maxT + buf, suggestedMin = minT - buf;
            const ctx = document.getElementById('weather-chart');
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets:[{
                    data: temps,
                    borderColor: 'var(--primary-color)',
                    tension: 0,
                    pointRadius:4,
                    pointBackgroundColor:'var(--primary-color)'
                }]},
                options: {
                    responsive:true,
                    maintainAspectRatio:false,
                    plugins:{ legend:{display:false},
                        datalabels:{
                            display:ctx=>ctx.dataIndex===maxI||ctx.dataIndex===minI,
                            align:ctx=>ctx.dataIndex===maxI?'top':'bottom',
                            anchor:ctx=>ctx.dataIndex===maxI?'end':'start',
                            offset:6,
                            color:ctx=>ctx.dataIndex===maxI?'red':'blue',
                            font:{weight:'bold'},
                            formatter:(v,ctx)=>ctx.dataIndex===maxI?`ìµœê³  ${v}Â°`:`ìµœì € ${v}Â°`
                        }
                    },
                    scales:{ x:{grid:{display:false}},
                        y:{grid:{color:'#eee'},
                            suggestedMin, suggestedMax
                        }
                    }
                },
                plugins:[ChartDataLabels]
            });
        }

        // ì½”ë”” ì¶”ì²œ í˜¸ì¶œ
        async function updateOutfit() {
            if (!lastForecast) return;
            const avgTemp = calcAvgTemp(lastForecast);
            const style = document.querySelector('input[name="style"]:checked').value;
            const res = await fetch(`/outfit?temp=${avgTemp.toFixed(1)}&style=${style}`);
            const { outfit } = await res.json();
            outfitEl.textContent = outfit;
            renderChart(lastForecast);
        }

        // ë‚ ì”¨ í‘œì‹œ
        async function showWeather(nx, ny, name) {
            const { forecast } = await fetchWeather(nx, ny);
            console.log({forecast})
            renderSummary(forecast, name);
            renderChart(forecast);
        }

        // ì´ë²¤íŠ¸ ë°”ì¸ë”©
        btnLoc.addEventListener('click', () => {
            btnLoc.disabled = true;
            navigator.geolocation.getCurrentPosition(async pos => {
                const { latitude:lat, longitude:lon } = pos.coords;
                const { regions } = await fetch(`/regions?lat=${lat}&lon=${lon}`).then(r=>r.json());
                if (regions.length) showWeather(regions[0].nx, regions[0].ny, regions[0].name);
                btnLoc.disabled = false;
            },()=>{ btnLoc.disabled=false; });
        });

        btnSearch.addEventListener('click', async () => {
            const kw = searchInput.value.trim();
            if (!kw) return;
            btnSearch.disabled = true;
            const { regions } = await fetch(`/regions?keyword=${kw}`).then(r=>r.json());
            resultsEl.innerHTML = '';
            regions.forEach(r => {
                const li = document.createElement('li');
                li.textContent = r.name;
                li.onclick = () => { showWeather(r.nx, r.ny, r.name); resultsEl.innerHTML=''; };
                resultsEl.appendChild(li);
            });
            btnSearch.disabled = false;
        });

        searchInput.addEventListener('keydown', e => { if (e.key==='Enter') btnSearch.click(); });
        styleInputs.forEach(el => el.addEventListener('change', updateOutfit));
    </script>
</body>
</html>